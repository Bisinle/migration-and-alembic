# Migrations and Alembic

# migrations

### Setting Up a Migration Base:

You're starting by creating a kind of `checkpoint` for your database schema changes. It's like saying, `From now on, I'll keep track of any changes I make to the database structure.` This is similar to version control like Git, but for
databases.

### Generating a Migration:

`alembic revision -m "Empty init`

Imagine you're taking a snapshot of your database structure right now. You're not changing anything yet, just setting up the ability to record changes. When you run the command, it's like taking that snapshot and giving it a name, "Empty Init" in this case.

#### <u>What's Inside the Migration File:</u>

```Empty Init

Revision ID: 6b9cb35ba46e
Revises:
Create Date: 2022-08-04 13:21:26.936909

"""
from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision = '6b9cb35ba46e'
down_revision = None
branch_labels = None
depends_on = None


def upgrade() -> None:
    pass


def downgrade() -> None:
    pass
```

Inside the generated snapshot, you see a message at the top, like a title for your snapshot. It's good to `describe what change you're making`. Then, there are two sections: `upgrade() and downgrade().`

upgrade(): This is like instructions for making changes to your database. If you're adding something new, like a table or a column, you'd put those instructions here.
downgrade(): Think of this as the reverse instructions. If you ever need to undo the changes, these instructions would help you go back to the previous state.
Applying the Migration:

Now, you're taking that snapshot you made and actually applying the changes to your database. It's like pressing a button that says, "Make my database match what's in the snapshot." This helps keep your database up-to-date as you make more changes over time.

`alembic upgrade head`

The "head" is the latest snapshot, and you're upgrading your database to that point/newest version. If there are older snapshots too, the tool will apply them in order to catch up your database.

#### sammery

This process sets up a way to manage changes to your database in the future. When you change how your data is structured, like adding new types of information, you'll use tools like Alembic to create these snapshots automatically. Then, when you apply those snapshots, your database will change to match your new instructions.

In simpler terms, you're making sure you have a record of changes you make to your database, and tools like Alembic help you apply those changes when needed. It's like a safety net for your data structure.

## Adding a data model

we define a new data model in our code that repersents the table in the databse. how the table should lool, how many columns it should have, and the realtionship between them

## Generating an automatic migration

when we are ready to add the new model to our databse, we ask `alembic` to generate the code need for the migration, this is like telling `alembic` to figur our how the database needs to change to match our new model, so alembic takes snapshot of the db and then does the comparison

```
alembic revision --autogenerate -m "Added Student model"
```

```INFO [alembic.runtime.migration] Context impl SQLiteImpl.
INFO  [alembic.runtime.migration] Will assume non-transactional DDL.
INFO  [alembic.autogenerate.compare] Detected added table 'students'
INFO  [alembic.autogenerate.compare] Detected added index 'ix_students_name' on '['name']'
  Generating /python-p3-migrations-and-alembic/app/migrations/versions/361dae855898_added_model.py ...  done
```

## Comparing the class model with current structure of the database

alembic compare the code for the new data model we have created to the current state of our databse, it is like comparing the blue pring for the table to what our database currently looks like

## Detecting changes

`alembic`, after comparing the data model to our database, it notices that the differenc is that we added a new data modea `students table` and the index for the search,

## Inside the generated migration script, you'll find code that:

````
"""Added Student model

Revision ID: 361dae855898
Revises: 6b9cb35ba46e
Create Date: 2022-08-04 14:21:32.441071

"""
from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision = '361dae855898'
down_revision = '6b9cb35ba46e'
branch_labels = None
depends_on = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('students',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(), nullable=True),
    sa.Column('email', sa.String(length=55), nullable=True),
    sa.Column('grade', sa.Integer(), nullable=True),
    sa.Column('birthday', sa.DateTime(), nullable=True),
    sa.Column('enrolled_date', sa.DateTime(), nullable=True),
    sa.PrimaryKeyConstraint('id'),
    )
    op.create_index(op.f('ix_students_name'), 'students', ['name'], unique=False)
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f('ix_students_name'), table_name='students')
    op.drop_table('students')
    # ### end Alembic commands ###```

1. Creates the "students" table with the correct columns and data types based on your data model.

2. down_revision has been added. This points to the ID for the previous migration file. this will be used if we ever downgrade our database- it tells Alembic the order in which to undo revisions.

3. Adds the index on the "name" column to speed up searches.
4. we can observe that both the upgrade () and downgrade () function have been populated, `alembic` executes upgrade code
5. Provides instructions on how to undo these changes if needed (in the downgrade() function).
````

## now we run the autogenerated migration to create our student table

````
$ alembic upgrade head
INFO  [alembic.runtime.migration] Context impl SQLiteImpl.
INFO  [alembic.runtime.migration] Will assume non-transactional DDL.
INFO  [alembic.runtime.migration] Running upgrade 6b9cb35ba46e -> 361dae855898, Added Student model```
````

# Solution Code

```
# models.py

from datetime import datetime

from sqlalchemy import create_engine, desc
from sqlalchemy import Column, DateTime, Integer, String

from sqlalchemy.ext.declarative import declarative_base

engine = create_engine('sqlite:///migrations_test.db')

Base = declarative_base()

class Student(Base):
    __tablename__ = 'students'

    id = Column(Integer(), primary_key=True)
    name = Column(String(), index=True)
    email = Column(String(55))
    grade = Column(Integer())
    birthday = Column(DateTime())
    enrolled_date = Column(DateTime(), default=datetime.now())

    def __repr__(self):
        return f"Student {self.id}: " \
            + f"{self.name}, " \
            + f"Grade {self.grade}"

```

```

# alembic.ini
# line 58
sqlalchemy.url = sqlite:///migrations_test.db
```

```
# env.py

# migrations/env.py
# lines 21-22
from models import Base
target_metadata = Base.metadata

```
